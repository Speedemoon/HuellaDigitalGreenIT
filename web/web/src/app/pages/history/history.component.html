<section class="container hist">
  <h2>Historial</h2>
  <p>Aquí se guardan tus cálculos. Puedes comparar resultados y ver tu evolución.</p>

  <div class="bar">
    <button class="btn ghost" (click)="load()">Actualizar</button>

    <div class="filters">
      <span>Filtro:</span>
      <button class="chip" [class.active]="filter==='Todos'" (click)="setFilter('Todos')">Todos</button>
      <button class="chip" [class.active]="filter==='Bajo'" (click)="setFilter('Bajo')">Bajo</button>
      <button class="chip" [class.active]="filter==='Medio'" (click)="setFilter('Medio')">Medio</button>
      <button class="chip" [class.active]="filter==='Alto'" (click)="setFilter('Alto')">Alto</button>
    </div>
  </div>

  <p class="msg" *ngIf="loading">Cargando...</p>
  <p class="msg err" *ngIf="error">{{ error }}</p>

  <div class="table-wrap" *ngIf="!loading">
    <table class="table" *ngIf="viewRows.length; else emptyState">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>kWh/mes</th>
          <th>CO₂/mes</th>
          <th>Nivel</th>
          <th>Mayor aporte</th>
          <th>Streaming</th>
          <th>Gaming</th>
          <th>Videollamadas</th>
          <th>Redes</th>
          <th>Cloud</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of viewRows">
          <td>{{ formatDate(r.created_at) }}</td>
          <td>{{ fmt(r.total_kwh_month, 2) }}</td>
          <td>{{ fmt(r.total_co2_month, 2) }}</td>
          <td><span [class]="levelClass(r.level)">{{ r.level || '-' }}</span></td>
          <td>{{ r.top_contribution || '-' }}</td>
          <td>{{ fmt(r.stream_video_hours_week, 2) }}</td>
          <td>{{ fmt(r.gaming_hours_week, 2) }}</td>
          <td>{{ fmt(r.videocalls_hours_week, 2) }}</td>
          <td>{{ fmt(r.social_hours_week, 2) }}</td>
          <td>{{ fmt(r.cloud_hours_week, 2) }}</td>
        </tr>
      </tbody>
    </table>

    <ng-template #emptyState>
      <div class="empty">No hay registros todavía.</div>
    </ng-template>
  </div>
</section>
