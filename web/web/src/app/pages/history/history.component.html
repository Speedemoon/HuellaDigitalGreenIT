<div class="wrap">
  <div class="head">
    <div>
      <h2>Historial</h2>
      <p class="sub">Aquí se guardan tus cálculos. Puedes comparar resultados y ver tu evolución.</p>
    </div>

    <div class="right">
      <button class="btn-outline" (click)="refresh()">Actualizar</button>
      <span class="tip">Tip: si acabas de guardar, dale a Actualizar.</span>
    </div>
  </div>

  <div class="filters">
    <div class="lbl">Filtro:</div>
    <button class="chip" [class.active]="isActiveFilter('Todos')" (click)="setFilter('Todos')">Todos</button>
    <button class="chip" [class.active]="isActiveFilter('Bajo')" (click)="setFilter('Bajo')">Bajo</button>
    <button class="chip" [class.active]="isActiveFilter('Medio')" (click)="setFilter('Medio')">Medio</button>
    <button class="chip" [class.active]="isActiveFilter('Alto')" (click)="setFilter('Alto')">Alto</button>
  </div>

  <p class="error" *ngIf="errorMsg">{{ errorMsg }}</p>

  <div class="summary" *ngIf="!loading && viewRows.length">
    <div class="box">
      <div class="label">Registros</div>
      <div class="value">{{ totalRegistros }}</div>
    </div>

    <div class="box">
      <div class="label">Promedio kWh/mes</div>
      <div class="value">{{ promedioKwh | number:'1.2-2' }}</div>
    </div>

    <div class="box">
      <div class="label">Promedio CO₂/mes</div>
      <div class="value">{{ promedioCo2 | number:'1.2-2' }}</div>
    </div>

    <div class="box">
      <div class="label">Último nivel</div>
      <div class="value"><span [class]="levelClass(ultimoNivel)">{{ ultimoNivel }}</span></div>
    </div>
  </div>

  <div class="state" *ngIf="loading">
    Cargando historial...
  </div>

  <div class="state" *ngIf="!loading && viewRows.length === 0">
    No hay registros todavía.
  </div>

  <div class="tableWrap" *ngIf="!loading && viewRows.length">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Fecha</th>
          <th>kWh/mes</th>
          <th>CO₂/mes</th>
          <th>Nivel</th>
          <th>Mayor aporte</th>
          <th>Streaming</th>
          <th>Gaming</th>
          <th>Videollamadas</th>
          <th>Redes</th>
          <th>Cloud</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of viewRows; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ formatDate(r.created_at) }}</td>
          <td>{{ r.total_kwh_month | number:'1.2-2' }}</td>
          <td>{{ r.total_co2_month | number:'1.2-2' }}</td>
          <td><span [class]="levelClass(r.level)">{{ r.level }}</span></td>
          <td>{{ r.top_contribution }}</td>
          <td>{{ r.stream_video_hours_week | number:'1.0-2' }}</td>
          <td>{{ r.gaming_hours_week | number:'1.0-2' }}</td>
          <td>{{ r.videocalls_hours_week | number:'1.0-2' }}</td>
          <td>{{ r.social_hours_week | number:'1.0-2' }}</td>
          <td>{{ r.cloud_hours_week | number:'1.0-2' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
